# Generated by https://github.com/anoru/data-ci-cd-template
# Save the docker image as a tarball in github artifact
# In order to send it to smart services team

name: save-artifacts
on:
  push:
    branches:
      - main
jobs:
  save-artifacts:
    name: Save a docker image & a model file to artifact
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Create artifact folder
        run: mkdir -p deployment/artifacts
      - name: Declare variables
        run: cat setup.py | grep version | grep -E "([0-9]+.[0-9]+.[0-9]+)" --only-matching > TAG_VERSION
      - name: Build the inference image
        run: docker build -t {project_slug}:$(cat TAG_VERSION) -f src/{project_slug_under}/Dockerfile.endpoint .
      - name: Save the image
        run: docker save {project_slug}:$(cat TAG_VERSION) > deployment/artifacts/{project_slug}-$(cat TAG_VERSION).tar
      - name: Gzip the image
        run: gzip -c deployment/artifacts/{project_slug}-$(cat TAG_VERSION).tar > deployment/artifacts/{project_slug}-$(cat TAG_VERSION).tar.gz
      - name: Copy the model
        run: |
          if [ -f deployment/models/{project_slug}-model-$(cat TAG_VERSION).tar.gz ]; then 
            cp deployment/models/{project_slug}-model-$(cat TAG_VERSION).tar.gz deployment/artifacts/ 
          fi
      - name: Upload artifact
        uses: actions/upload-artifact@v2
        with:
          name: {project_slug}
          path: deployment/artifacts/{project_slug}-*.tar.gz
          retention-days: 3
